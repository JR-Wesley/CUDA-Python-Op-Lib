cmake_minimum_required(VERSION 3.18)
project(cuda_vec_add LANGUAGES CXX CUDA)

# è®¾ç½®æ ‡å‡†
set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CUDA_STANDARD 17)

# ğŸ”§ è®¾ç½® LibTorch è·¯å¾„ï¼ˆä¿®æ”¹ä¸ºä½ è‡ªå·±çš„è·¯å¾„ï¼‰
set(LIBTORCH ${CMAKE_CURRENT_SOURCE_DIR}/../libtorch)
list(APPEND CMAKE_PREFIX_PATH "${LIBTORCH}")
find_package(Torch REQUIRED)

# Find files
file(GLOB BIND_SOURCES "binding/binding.cpp")
file(GLOB KERNEL_SOURCES "kernel/*.cu")

set(TEST_FILES
    test/test_vec_add_torch.cpp  # ä¸»æ–‡ä»¶ä¹ŸåŒ…å«è¿›æ¥
    test/test_mm.cpp
)

# éå†æ‰€æœ‰æµ‹è¯•æ–‡ä»¶ï¼Œä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºå¯æ‰§è¡Œç›®æ ‡
foreach(TEST_FILE ${TEST_FILES})
# ä»æ–‡ä»¶åæå–ç›®æ ‡åç§°ï¼ˆä¾‹å¦‚ test_mm.cpp -> test_mmï¼‰
  get_filename_component(TARGET_NAME ${TEST_FILE} NAME_WE)

# åˆ›å»ºå¯æ‰§è¡Œç›®æ ‡
  add_executable(${TARGET_NAME}
      ${TEST_FILE}
      ${BIND_SOURCES}
      ${KERNEL_SOURCES}
    )

# Link torch lib
  target_link_libraries(${TARGET_NAME} "${TORCH_LIBRARIES}")

# ç¼–è¯‘é€‰é¡¹
  target_compile_options(${TARGET_NAME} PRIVATE
    $<$<COMPILE_LANGUAGE:CUDA>:-O3 --use_fast_math -arch=sm_89>
    $<$<COMPILE_LANGUAGE:CXX>:-O3>
  )

#  è¾“å‡ºä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
  message(STATUS "Target: ${TARGET_NAME}")
  message(STATUS "Sources: ${ALL_SOURCES}")
endforeach()
